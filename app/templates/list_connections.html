<style>
    .status-dot {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 10px;
    }
    
    .bg-success {
        background-color: #28a745; /* Verde */
    }
    
    .bg-danger {
        background-color: #dc3545; /* Rojo */
    }
    
    .bg-warning {
        background-color: #ffc107; /* Naranja */
    }

    .blinking {
        animation: fadeInOut 1s infinite;
    }
    
    @keyframes fadeInOut {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
    }

    .clickable-row {
        cursor: pointer;
    }

</style>

<div class="container mt-5">
    <h1 class="text-center">Conexiones Guardadas</h1>
    <table id="connectionsTable" class="table table-striped mt-4 table-hover">
        <thead>
            <tr>
                <th>Estado</th>
                <th>Nombre</th>
                <th>Tipo</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="connectionsTableBody">
            <!-- Las filas se actualizarán dinámicamente -->
        </tbody>
    </table>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        async function fetchConnections() {
            try {
                const response = await fetch('/storage/connections', {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (response.ok) {
                    const connections = await response.json();
                    const connectionsTable = document.querySelector('#connectionsTableBody');

                    if (!connectionsTable) {
                        console.error('El elemento #connectionsTableBody no existe en el DOM.');
                        return;
                    }

                    connectionsTable.innerHTML = '';

                    connections.forEach(connection => {
                        const row = document.createElement('tr');
                        row.classList.add('clickable-row');
                        row.setAttribute('data-url', `/storage/${connection.type}/${connection.id}/list`);
                        row.innerHTML = `
                            <td>
                                <span class="status-dot ${
                                    connection.status === 'mount' ? 'bg-success blinking' :
                                    connection.status === 'success' ? 'bg-success' :
                                    connection.status === 'error' ? 'bg-danger' : 'bg-warning'
                                }"></span>
                            </td>
                            <td>${connection.name}</td>
                            <td>${connection.type.charAt(0).toUpperCase() + connection.type.slice(1)}</td>
                            <td>
                                <button class="btn btn-sm btn-info mount-folder" data-id="${connection.id}">
                                    Montar Carpeta
                                </button>
                            </td>
                        `;
                        connectionsTable.appendChild(row);
                    });

                    // Hacer que las filas sean clicables
                    document.querySelectorAll('.clickable-row').forEach(row => {
                        row.addEventListener('click', function () {
                            const url = this.getAttribute('data-url');
                            if (url) {
                                window.location.href = url;
                            }
                        });
                    });

                    // Manejar el botón de montar carpeta
                    document.querySelectorAll('.mount-folder').forEach(button => {
                        button.addEventListener('click', async function (event) {
                            event.stopPropagation(); // Evitar que el evento de clic en la fila se dispare
                            const connectionId = this.getAttribute('data-id');
                            try {
                                const mountResponse = await fetch(`/storage/mount/${connectionId}`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    }
                                });
                                if (mountResponse.ok) {
                                    alert('Carpeta montada con éxito.');
                                    fetchConnections(); // Actualizar la lista de conexiones
                                } else {
                                    alert('Error al montar la carpeta.');
                                }
                            } catch (error) {
                                console.error('Error al montar la carpeta:', error);
                            }
                        });
                    });
                } else {
                    console.error('Error al obtener las conexiones:', response.statusText);
                }
            } catch (error) {
                console.error('Error al realizar la solicitud:', error);
            } finally {
                // Esperar 5 segundos antes de realizar la siguiente llamada
                setTimeout(fetchConnections, 5000);
            }
        }

        // Llamar a fetchConnections al cargar la página
        fetchConnections();
    });
</script>